<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitQuest - CodePen Version</title>
    
    <!-- 1. Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM Styles/Scripts will be loaded via Module below -->
    <style>
        /* Anima√ß√µes personalizadas do Tailwind */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .animate-slide-up { animation: slide-up 0.5s ease-out; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Custom Scrollbar for the exercise grid */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="module">
        // --- IMPORTS VIA CDN (ESM) PARA CODEPEN ---
        import React, { useState, useEffect } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
        
        // Lucide Icons
        import { 
          Trophy, Flame, Dumbbell, Footprints, PlusCircle, ShoppingBag, 
          Users, Activity, CheckCircle2, TrendingUp, User as UserIcon, 
          Medal, LogIn, LogOut, Lock, Wifi, WifiOff, AlertTriangle, RefreshCw,
          Target, Flag, Crown, Mountain, Music, Heart, Zap, Trash2, Calendar, Edit2, X,
          Bike, Waves, Sword, Gamepad2, Skull, Sparkles // Added Sparkles
        } from "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0";

        // Firebase v10
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
          getAuth, signInAnonymously, onAuthStateChanged, 
          signInWithCustomToken, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
          getFirestore, collection, doc, setDoc, updateDoc, 
          onSnapshot, addDoc, serverTimestamp, increment, getDocs, query, where, getDoc, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- SUA CONFIGURA√á√ÉO ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHxhzQMlkv7dkbfNwnvnNd4ssTO0foo4s",
            authDomain: "academia-2823f.firebaseapp.com",
            projectId: "academia-2823f",
            storageBucket: "academia-2823f.firebasestorage.app",
            messagingSenderId: "989949355006",
            appId: "1:989949355006:web:ef7b7eba75e4a8134c96af"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const COLLECTION_NAME = "fitquest_users"; 
        const FEED_COLLECTION_NAME = "fitquest_feed";
        const CHALLENGES_COLLECTION_NAME = "fitquest_challenges";
        const EXERCISES_COLLECTION_NAME = "fitquest_exercises"; 

        // --- Constants & Helpers ---
        const LEVELS = [0, 500, 1200, 2500, 5000, 10000]; 
        const DEFAULT_AVATARS = ['ü¶Å', 'üêØ', 'üêª', 'ü¶Ö', 'ü¶à', 'üê∫', 'ü¶ç', 'ü¶ñ', 'üêâ', 'ü¶è'];

        const ICON_MAP = {
            Flame, Trophy, Dumbbell, Mountain, Music, Activity, Footprints, Heart, Zap,
            Bike, Waves, Sword, Gamepad2, Skull, Target, Medal
        };

        const DEFAULT_EXERCISES = [
            { id: 'hotyoga', label: 'Hotyoga', xp: 150, iconKey: 'Flame', color: 'orange' },
            { id: 'volei', label: 'V√¥lei', xp: 125, iconKey: 'Trophy', color: 'yellow' },
            { id: 'futebol', label: 'Futebol', xp: 200, iconKey: 'Trophy', color: 'green' },
            { id: 'trilha', label: 'Trilha', xp: 200, iconKey: 'Mountain', color: 'emerald' },
            { id: 'danca', label: 'Dan√ßa', xp: 125, iconKey: 'Music', color: 'pink' },
            { id: 'pilates', label: 'Pilates', xp: 175, iconKey: 'Activity', color: 'cyan' },
            { id: 'caminhada', label: 'Caminhada', xp: 100, iconKey: 'Footprints', color: 'teal' },
            { id: 'corrida', label: 'Corrida', xp: 150, iconKey: 'Footprints', color: 'blue' },
            { id: 'musculacao', label: 'Muscula√ß√£o', xp: 125, iconKey: 'Dumbbell', color: 'indigo' },
            { id: 'cardio', label: 'Cardio', xp: 100, iconKey: 'Heart', color: 'red' },
            { id: 'flashback', label: 'Flashback', xp: 125, iconKey: 'Zap', color: 'violet' },
            { id: 'musc_cardio', label: 'Musc. + Cardio', xp: 150, iconKey: 'Dumbbell', color: 'purple' }
        ];

        const getLevel = (xp) => {
          let level = 1;
          for (let i = 0; i < LEVELS.length; i++) {
            if (xp >= LEVELS[i]) level = i + 1;
            else break;
          }
          return level;
        };

        const getProgressToNextLevel = (xp) => {
          const level = getLevel(xp);
          const currentLevelXp = LEVELS[level - 1] || 0;
          const nextLevelXp = LEVELS[level] || LEVELS[LEVELS.length - 1] * 1.5;
          const progress = ((xp - currentLevelXp) / (nextLevelXp - currentLevelXp)) * 100;
          return Math.min(Math.max(progress, 0), 100);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'Data desc.';
            let date;
            if (timestamp.seconds) {
                date = new Date(timestamp.seconds * 1000);
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = timestamp;
            }
            const today = new Date();
            const isToday = date.getDate() === today.getDate() && 
                            date.getMonth() === today.getMonth() && 
                            date.getFullYear() === today.getFullYear();
            if (isToday) return `Hoje, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + 
                   ` √†s ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        };

        // --- LOCAL STORAGE MANAGER ---
        const LocalDB = {
            getUsers: () => JSON.parse(localStorage.getItem(COLLECTION_NAME) || '[]'),
            saveUser: (user) => {
                const users = LocalDB.getUsers();
                const index = users.findIndex(u => u.id === user.id);
                if (index >= 0) users[index] = { ...users[index], ...user };
                else users.push(user);
                localStorage.setItem(COLLECTION_NAME, JSON.stringify(users));
            },
            getFeed: () => JSON.parse(localStorage.getItem(FEED_COLLECTION_NAME) || '[]'),
            saveFeed: (feed) => localStorage.setItem(FEED_COLLECTION_NAME, JSON.stringify(feed)),
            addToFeed: (item) => {
                const feed = LocalDB.getFeed();
                feed.unshift(item); 
                localStorage.setItem(FEED_COLLECTION_NAME, JSON.stringify(feed.slice(0, 50))); 
            },
            updateFeedItem: (updatedItem) => {
                const feed = LocalDB.getFeed();
                const index = feed.findIndex(i => i.id === updatedItem.id);
                if(index >= 0) {
                    feed[index] = { ...feed[index], ...updatedItem };
                    LocalDB.saveFeed(feed);
                }
            },
            getChallenges: () => JSON.parse(localStorage.getItem(CHALLENGES_COLLECTION_NAME) || '[]'),
            saveChallenge: (challenge) => {
                const challenges = LocalDB.getChallenges();
                const index = challenges.findIndex(c => c.id === challenge.id);
                if (index >= 0) challenges[index] = { ...challenges[index], ...challenge };
                else challenges.push(challenge);
                localStorage.setItem(CHALLENGES_COLLECTION_NAME, JSON.stringify(challenges));
            },
            getCustomExercises: () => JSON.parse(localStorage.getItem(EXERCISES_COLLECTION_NAME) || '[]'),
            saveCustomExercise: (ex) => {
                const list = LocalDB.getCustomExercises();
                list.push(ex);
                localStorage.setItem(EXERCISES_COLLECTION_NAME, JSON.stringify(list));
            }
        };

        // --- COMPONENTES ---

        function NavButton({ Icon, label, active, onClick }) {
          return React.createElement('button', {
            onClick: onClick,
            className: `flex flex-col items-center gap-1 p-2 transition-colors ${active ? 'text-orange-400' : 'text-slate-400 hover:text-slate-200'}`
          }, [
            React.createElement(Icon, { size: 24, key: 'icon' }),
            React.createElement('span', { className: "text-[10px] font-medium", key: 'label' }, label)
          ]);
        }

        const calculateEffectiveStreak = (user) => {
            let streak = user.streak || 0;
            if (user.lastWorkout) {
                let lastDate;
                if (user.lastWorkout.seconds) {
                    lastDate = new Date(user.lastWorkout.seconds * 1000);
                } else if (typeof user.lastWorkout === 'string') {
                    lastDate = new Date(user.lastWorkout);
                } else {
                    lastDate = new Date(user.lastWorkout);
                }
                lastDate.setHours(0,0,0,0);
                
                const today = new Date();
                today.setHours(0,0,0,0);
                
                const diffTime = today.getTime() - lastDate.getTime();
                const diffDays = Math.round(diffTime / (1000 * 3600 * 24));
                
                if (diffDays > 1) {
                    streak = 0;
                }
            }
            return streak;
        };

        function Dashboard({ user, onLogClick, leaderboard, currentUserId }) {
          const displayStreak = calculateEffectiveStreak(user);

          return (
            React.createElement('div', { className: "space-y-6 animate-fade-in" }, [
              // Streak Card
              React.createElement('div', { className: `bg-gradient-to-br ${displayStreak > 0 ? 'from-orange-500 to-red-600' : 'from-slate-700 to-slate-600'} rounded-2xl p-6 text-white shadow-lg relative overflow-hidden`, key: 'streak' }, [
                React.createElement('div', { className: "absolute right-0 top-0 opacity-20 transform translate-x-4 -translate-y-4" }, React.createElement(Flame, { size: 120 })),
                React.createElement('div', { className: "relative z-10" }, [
                  React.createElement('div', { className: "text-sm font-medium opacity-90 mb-1" }, "Sequ√™ncia Atual"),
                  React.createElement('div', { className: "text-4xl font-black flex items-end gap-2" }, [
                    displayStreak,
                    React.createElement('span', { className: "text-lg font-normal mb-1" }, "dias")
                  ]),
                  React.createElement('p', { className: "text-xs opacity-75 mt-2" }, displayStreak > 0 ? "Mantenha a consist√™ncia para ganhar b√¥nus de XP!" : "Registre um treino hoje para iniciar sua sequ√™ncia!")
                ])
              ]),

              // Stats Grid
              React.createElement('div', { className: "grid grid-cols-2 gap-4", key: 'stats' }, [
                React.createElement('div', { className: "bg-slate-800 p-4 rounded-xl border border-slate-700" }, [
                  React.createElement('div', { className: "text-slate-400 text-xs uppercase font-bold tracking-wider mb-1" }, "Total Treinos"),
                  React.createElement('div', { className: "text-2xl font-bold text-white flex items-center gap-2" }, [
                    React.createElement(Dumbbell, { size: 20, className: "text-blue-400" }),
                    user.workoutsCompleted || Math.floor((user.xp || 0) / 100) 
                  ])
                ]),
                React.createElement('div', { className: "bg-slate-800 p-4 rounded-xl border border-slate-700" }, [
                  React.createElement('div', { className: "text-slate-400 text-xs uppercase font-bold tracking-wider mb-1" }, "N√≠vel"),
                  React.createElement('div', { className: "text-2xl font-bold text-white flex items-center gap-2" }, [
                    React.createElement(Trophy, { size: 20, className: "text-yellow-400" }),
                    getLevel(user.xp || 0)
                  ])
                ])
              ]),

              // Quick Action
              React.createElement('div', { className: "bg-slate-800/50 p-6 rounded-xl border border-dashed border-slate-700 flex flex-col items-center justify-center text-center gap-3", key: 'action' }, [
                React.createElement('p', { className: "text-slate-400" }, "Terminou o treino de hoje?"),
                React.createElement('button', { 
                  onClick: onLogClick,
                  className: "bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-colors w-full"
                }, "Registrar Atividade")
              ]),

              // Ranking (Integrado)
              React.createElement('div', { className: "pt-4 border-t border-slate-700", key: 'ranking-section' }, [
                 React.createElement(Leaderboard, { users: leaderboard, currentUserId: currentUserId })
              ])
            ])
          );
        }

        function AdminExerciseModal({ onClose, onSave }) {
            const [name, setName] = useState('');
            const [xp, setXp] = useState('100');
            const [selectedIcon, setSelectedIcon] = useState('Dumbbell');
            const [color, setColor] = useState('blue');

            const icons = Object.keys(ICON_MAP);
            const colors = ['blue', 'red', 'green', 'yellow', 'purple', 'pink', 'orange', 'cyan', 'emerald'];

            return React.createElement('div', { className: "fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 animate-fade-in" }, [
                React.createElement('div', { className: "bg-slate-800 rounded-2xl w-full max-w-sm p-6 border border-slate-600 shadow-2xl relative" }, [
                    React.createElement('button', { onClick: onClose, className: "absolute top-4 right-4 text-slate-400 hover:text-white" }, React.createElement(X)),
                    React.createElement('h3', { className: "text-xl font-bold text-white mb-4 flex items-center gap-2" }, [
                        React.createElement(Lock, { size: 20, className: "text-yellow-500" }), " Adicionar Exerc√≠cio"
                    ]),
                    
                    React.createElement('div', { className: "space-y-4" }, [
                        React.createElement('div', null, [
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase mb-1 block" }, "Nome do Exerc√≠cio"),
                            React.createElement('input', { type: "text", value: name, onChange: e => setName(e.target.value), className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white outline-none focus:border-yellow-500" })
                        ]),
                        React.createElement('div', null, [
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase mb-1 block" }, "XP Base"),
                            React.createElement('input', { type: "number", value: xp, onChange: e => setXp(e.target.value), className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white outline-none focus:border-yellow-500" })
                        ]),
                        React.createElement('div', null, [
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase mb-1 block" }, "√çcone"),
                            React.createElement('div', { className: "grid grid-cols-5 gap-2 max-h-32 overflow-y-auto custom-scrollbar bg-slate-900 p-2 rounded border border-slate-700" }, 
                                icons.map(iconName => {
                                    const IconComp = ICON_MAP[iconName];
                                    return React.createElement('button', {
                                        key: iconName,
                                        onClick: () => setSelectedIcon(iconName),
                                        className: `p-2 rounded flex justify-center items-center ${selectedIcon === iconName ? 'bg-yellow-500 text-black' : 'text-slate-400 hover:bg-slate-700'}`
                                    }, React.createElement(IconComp, { size: 18 }));
                                })
                            )
                        ]),
                        React.createElement('div', null, [
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase mb-1 block" }, "Cor"),
                            React.createElement('div', { className: "flex gap-2 overflow-x-auto pb-2" }, 
                                colors.map(c => React.createElement('button', {
                                    key: c,
                                    onClick: () => setColor(c),
                                    className: `w-8 h-8 rounded-full border-2 ${color === c ? 'border-white scale-110' : 'border-transparent'} bg-${c}-500`
                                }))
                            )
                        ]),
                        React.createElement('button', {
                            onClick: () => {
                                if(name && xp) {
                                    onSave({ 
                                        id: 'custom_' + Date.now(), 
                                        label: name, 
                                        xp: parseInt(xp), 
                                        iconKey: selectedIcon, 
                                        color: color 
                                    });
                                }
                            },
                            className: "w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg mt-2"
                        }, "Salvar no App")
                    ])
                ])
            ]);
        }

        function WorkoutLogger({ onLog, onCancel, initialData, availableExercises }) {
          const defaultExId = availableExercises && availableExercises.length > 0 ? availableExercises[0].id : '';
          const [type, setType] = useState(initialData?.workoutType || defaultExId);
          const [intensity, setIntensity] = useState(initialData?.intensity || 'normal');
          const [notes, setNotes] = useState(initialData?.notes || '');
          const [isFirstTime, setIsFirstTime] = useState(initialData?.isFirstTime || false); // New state
          
          const getTodayStr = () => {
              const d = new Date();
              return d.toISOString().split('T')[0];
          };
          
          const getInitialDateStr = () => {
              if (initialData?.timestamp) {
                  let d;
                  if (initialData.timestamp.seconds) d = new Date(initialData.timestamp.seconds * 1000);
                  else if (typeof initialData.timestamp === 'string') d = new Date(initialData.timestamp);
                  else d = new Date();
                  return d.toISOString().split('T')[0];
              }
              return getTodayStr();
          };

          const [dateStr, setDateStr] = useState(getInitialDateStr());

          return React.createElement('div', { className: "bg-slate-800 rounded-2xl p-4 border border-slate-700 shadow-xl animate-slide-up" }, [ // Reduced padding
            React.createElement('div', { className: "flex justify-between items-center mb-6", key: 'header' }, [
                React.createElement('h2', { className: "text-xl font-bold text-white flex items-center gap-2" }, [
                  React.createElement(initialData ? Edit2 : CheckCircle2, { className: "text-green-500" }),
                  initialData ? " Editar Treino" : " Registrar Treino"
                ]),
                initialData && React.createElement('button', { onClick: onCancel, className: "text-slate-400 hover:text-white" }, React.createElement(X))
            ]),
            React.createElement('div', { className: "space-y-6", key: 'form' }, [
              // Date Input - FIX APPLIED HERE
              React.createElement('div', null, [
                React.createElement('label', { className: "text-slate-400 text-sm font-medium mb-2 block" }, "Data"),
                React.createElement('div', { className: "relative w-full" }, [
                    React.createElement(Calendar, { size: 18, className: "absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none" }),
                    React.createElement('input', {
                        type: "date",
                        value: dateStr,
                        onChange: (e) => setDateStr(e.target.value),
                        className: "w-full bg-slate-900 border border-slate-700 rounded-lg py-3 pl-10 pr-3 text-white text-sm focus:border-blue-500 outline-none appearance-none"
                    })
                ])
              ]),

              React.createElement('div', null, [
                React.createElement('label', { className: "text-slate-400 text-sm font-medium mb-2 block" }, "Selecione o Treino"),
                React.createElement('div', { className: "grid grid-cols-3 gap-2 max-h-60 overflow-y-auto custom-scrollbar pr-1" }, 
                  availableExercises.map(opt => {
                      const IconComp = ICON_MAP[opt.iconKey] || Dumbbell; 
                      return React.createElement('button', {
                        key: opt.id,
                        onClick: () => setType(opt.id),
                        className: `p-2 rounded-xl border-2 flex flex-col items-center gap-1 transition-all min-h-[80px] justify-center ${type === opt.id ? `border-${opt.color}-500 bg-${opt.color}-500/20 text-${opt.color}-400` : 'border-slate-700 bg-slate-700/50 text-slate-400 hover:border-slate-600'}`
                      }, [
                        React.createElement(IconComp, { size: 24 }),
                        React.createElement('span', { className: "font-bold text-[10px] text-center leading-tight" }, opt.label),
                        React.createElement('span', { className: "text-[9px] opacity-60" }, `+${opt.xp}xp`)
                      ]);
                  })
                )
              ]),
              React.createElement('div', null, [
                React.createElement('label', { className: "text-slate-400 text-sm font-medium mb-2 block" }, "Intensidade"),
                React.createElement('div', { className: "flex bg-slate-700 rounded-lg p-1" }, [
                  React.createElement('button', {
                    onClick: () => setIntensity('normal'),
                    className: `flex-1 py-2 rounded-md text-sm font-medium transition-colors ${intensity === 'normal' ? 'bg-slate-600 text-white shadow' : 'text-slate-400'}`
                  }, "Normal (1x)"),
                  React.createElement('button', {
                    onClick: () => setIntensity('high'),
                    className: `flex-1 py-2 rounded-md text-sm font-medium transition-colors ${intensity === 'high' ? 'bg-red-500/20 text-red-400 shadow' : 'text-slate-400'}`
                  }, "Intenso üî•")
                ])
              ]),
              
              // NEW CHECKBOX
              React.createElement('div', { className: "flex items-center gap-3 bg-slate-700/30 p-3 rounded-lg border border-slate-600" }, [
                  React.createElement('input', {
                      type: "checkbox",
                      id: "firstTimeCheck",
                      checked: isFirstTime,
                      onChange: (e) => setIsFirstTime(e.target.checked),
                      className: "w-5 h-5 rounded border-slate-500 text-green-500 focus:ring-green-500 bg-slate-800"
                  }),
                  React.createElement('label', { htmlFor: "firstTimeCheck", className: "text-sm text-slate-300 font-medium cursor-pointer select-none flex-1 flex items-center gap-2" }, [
                      "Primeira vez praticando?",
                      React.createElement('span', { className: "text-xs bg-purple-600 text-white px-1.5 py-0.5 rounded font-bold" }, "+100 XP")
                  ])
              ]),

              React.createElement('div', null, [
                React.createElement('label', { className: "text-slate-400 text-sm font-medium mb-2 block" }, "Notas (Opcional)"),
                React.createElement('textarea', {
                  value: notes,
                  onChange: (e) => setNotes(e.target.value),
                  className: "w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-blue-500 outline-none",
                  rows: 3
                })
              ]),
              React.createElement('div', { className: "flex gap-3 pt-4" }, [
                !initialData && React.createElement('button', { onClick: onCancel, className: "flex-1 py-3 rounded-lg font-medium text-slate-400 hover:bg-slate-700 transition-colors" }, "Cancelar"),
                React.createElement('button', { 
                    onClick: () => onLog(type, intensity, notes, dateStr, isFirstTime), // Pass isFirstTime
                    className: "flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-bold text-white shadow-lg transition-colors" 
                }, initialData ? "Salvar Altera√ß√µes" : "Confirmar")
              ])
            ])
          ]);
        }

        function Leaderboard({ users, currentUserId }) {
           return React.createElement('div', { className: "space-y-4" }, [
             React.createElement('h2', { className: "text-xl font-bold text-white mb-4 flex items-center gap-2", key: 'title' }, [
               React.createElement(Trophy, { className: "text-yellow-500" }),
               " Ranking Global"
             ]),
             React.createElement('div', { className: "space-y-2", key: 'list' }, 
               users.map((u, index) => {
                 const realStreak = calculateEffectiveStreak(u);
                 return React.createElement('div', { 
                   key: u.id || index,
                   className: `flex items-center gap-4 p-3 rounded-xl border ${u.id === currentUserId ? 'bg-blue-900/30 border-blue-500/50' : 'bg-slate-800 border-slate-700'}`
                 }, [
                   React.createElement('div', { className: "flex-shrink-0 w-8 text-center font-bold text-slate-500" }, `#${index + 1}`),
                   React.createElement('div', { className: "h-10 w-10 rounded-full bg-slate-700 flex items-center justify-center text-xl" }, u.avatar),
                   React.createElement('div', { className: "flex-1 min-w-0" }, [
                     React.createElement('div', { className: "font-bold text-white truncate" }, u.username),
                     React.createElement('div', { className: "text-xs text-slate-400 flex items-center gap-1" }, [
                         `Lvl ${getLevel(u.xp || 0)} ‚Ä¢ `,
                         React.createElement('span', { className: realStreak > 0 ? "text-orange-400 font-bold" : "text-slate-600" }, `${realStreak} dias üî•`)
                     ])
                   ]),
                   React.createElement('div', { className: "font-mono font-bold text-orange-400" }, `${u.xp || 0} XP`)
                 ]);
               })
             )
           ]);
        }

        // --- Challenge List Component (Restored) ---
        function ChallengeList({ challenges, users, currentUserId, onCreateChallenge, onClaimWin }) {
          const [isCreating, setIsCreating] = useState(false);
          const [newTitle, setNewTitle] = useState('');
          const [newTarget, setNewTarget] = useState('1000');
          const [newPrize, setNewPrize] = useState('');

          return React.createElement('div', { className: "space-y-6" }, [
            React.createElement('div', { className: "flex justify-between items-center", key: 'header' }, [
              React.createElement('h2', { className: "text-xl font-bold text-white flex items-center gap-2" }, [
                React.createElement(Target, { className: "text-red-500" }), " Metas Coletivas"
              ]),
              React.createElement('button', {
                onClick: () => setIsCreating(!isCreating),
                className: "text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-lg text-white transition-colors"
              }, isCreating ? 'Cancelar' : '+ Novo Desafio')
            ]),

            isCreating && React.createElement('div', { className: "bg-slate-800 p-4 rounded-xl border border-slate-700 animate-fade-in", key: 'create-form' }, [
               React.createElement('h3', { className: "font-bold text-white mb-3" }, "Criar Competi√ß√£o"),
               React.createElement('input', { type: "text", placeholder: "T√≠tulo (ex: Corrida 2k XP)", className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2", value: newTitle, onChange: e => setNewTitle(e.target.value) }),
               React.createElement('div', { className: "flex gap-2 mb-2" }, [
                   React.createElement('input', { type: "number", placeholder: "Meta de XP", className: "flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm", value: newTarget, onChange: e => setNewTarget(e.target.value) }),
                   React.createElement('div', { className: "flex items-center text-slate-400 text-sm" }, "XP")
               ]),
               React.createElement('input', { type: "text", placeholder: "Pr√™mio (ex: Jantar pago)", className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2", value: newPrize, onChange: e => setNewPrize(e.target.value) }),
               React.createElement('button', {
                 onClick: () => { 
                    if(newTitle && newTarget && newPrize) { 
                        onCreateChallenge(newTitle, parseInt(newTarget), newPrize); 
                        setIsCreating(false); 
                        setNewTitle(''); setNewTarget(''); setNewPrize('');
                    } 
                 },
                 className: "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded"
               }, "Lan√ßar Desafio")
            ]),

            React.createElement('div', { className: "space-y-4", key: 'challenges-list' }, 
              challenges.length === 0 
                ? React.createElement('div', { className: "text-center text-slate-500 py-8" }, "Nenhum desafio ativo. Crie um!")
                : challenges.map(challenge => {
                    const isWinner = !!challenge.winnerId;
                    
                    return React.createElement('div', { key: challenge.id, className: `bg-slate-800 p-4 rounded-xl border ${isWinner ? 'border-yellow-500/50' : 'border-slate-700'}` }, [
                      // Header Card
                      React.createElement('div', { className: "flex justify-between items-start mb-4" }, [
                        React.createElement('div', null, [
                          React.createElement('h3', { className: "font-bold text-white text-lg" }, challenge.title),
                          React.createElement('div', { className: "text-xs text-slate-400 flex items-center gap-1" }, [
                            React.createElement(Flag, { size: 12 }), `Meta: ${challenge.targetXP} XP`
                          ]),
                          React.createElement('div', { className: "text-xs text-yellow-400 font-bold mt-1" }, `üèÜ Pr√™mio: ${challenge.prize}`)
                        ]),
                        isWinner && React.createElement('div', { className: "bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded text-xs font-bold border border-yellow-500/50" }, "FINALIZADO")
                      ]),

                      // Participants Bars
                      React.createElement('div', { className: "space-y-3" }, 
                         users.map(u => {
                             const startXp = challenge.baselines?.[u.id] || 0;
                             const currentXp = u.xp || 0;
                             const progress = Math.max(0, currentXp - startXp);
                             const percentage = Math.min((progress / challenge.targetXP) * 100, 100);
                             const isLeader = !isWinner && percentage >= 100;
                             const userWonThis = challenge.winnerId === u.id;

                             return React.createElement('div', { key: u.id, className: "relative" }, [
                                 React.createElement('div', { className: "flex justify-between text-xs mb-1" }, [
                                     React.createElement('span', { className: "font-bold text-slate-300 flex items-center gap-1" }, [
                                        u.avatar, u.username,
                                        userWonThis && React.createElement(Crown, { size: 14, className: "text-yellow-400 fill-yellow-400" })
                                     ]),
                                     React.createElement('span', { className: "text-slate-500" }, `${progress} / ${challenge.targetXP}`)
                                 ]),
                                 React.createElement('div', { className: "w-full bg-slate-900 h-2 rounded-full overflow-hidden" },
                                     React.createElement('div', { 
                                         className: `h-full transition-all duration-700 ${userWonThis ? 'bg-yellow-400' : 'bg-red-500'}`, 
                                         style: { width: `${percentage}%` } 
                                     })
                                 ),
                                 // Bot√£o de Reivindicar (se 100% e n√£o finalizado)
                                 (!isWinner && percentage >= 100 && u.id === currentUserId) && 
                                 React.createElement('button', {
                                     onClick: () => onClaimWin(challenge.id),
                                     className: "absolute right-0 -top-1 bg-yellow-500 hover:bg-yellow-400 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded animate-pulse"
                                 }, "REIVINDICAR VIT√ìRIA!")
                             ]);
                         })
                      )
                    ]);
                })
            )
          ]);
        }

        function RewardShop({ user, onAdd, onRedeem, onDelete }) { 
          const [isAdding, setIsAdding] = useState(false);
          const [newTitle, setNewTitle] = useState('');
          const [newCost, setNewCost] = useState('');
          
          const activeRewards = user.myRewards?.filter(r => !r.redeemed) || [];
          const currentCoins = user.coins || 0;

          return React.createElement('div', { className: "space-y-6" }, [
            React.createElement('div', { className: "flex justify-between items-center", key: 'header' }, [
              React.createElement('h2', { className: "text-xl font-bold text-white flex items-center gap-2" }, [
                React.createElement(ShoppingBag, { className: "text-purple-500" }), " Recompensas"
              ]),
              React.createElement('button', {
                onClick: () => setIsAdding(!isAdding),
                className: "text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-lg text-white transition-colors"
              }, isAdding ? 'Cancelar' : '+ Criar Nova')
            ]),
            
            isAdding && React.createElement('div', { className: "bg-slate-800 p-4 rounded-xl border border-slate-700 animate-fade-in", key: 'add-form' }, [
               React.createElement('input', { type: "text", placeholder: "Nome (ex: Pizza)", className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2", value: newTitle, onChange: e => setNewTitle(e.target.value) }),
               React.createElement('input', { type: "number", placeholder: "Custo", className: "w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2", value: newCost, onChange: e => setNewCost(e.target.value) }),
               React.createElement('button', {
                 onClick: () => { if(newTitle && newCost) { onAdd(newTitle, newCost); setIsAdding(false); setNewTitle(''); setNewCost(''); } },
                 className: "w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded"
               }, "Adicionar")
            ]),

            React.createElement('div', { className: "grid gap-3", key: 'rewards-list' }, 
              activeRewards.map(reward => {
                const percentage = Math.min((currentCoins / reward.cost) * 100, 100);
                return React.createElement('div', { key: reward.id, className: "bg-slate-800 p-4 rounded-xl border border-slate-700 relative" }, [ 
                  React.createElement('div', { className: "flex justify-between items-start mb-3" }, [
                     React.createElement('div', null, [
                       React.createElement('div', { className: "font-bold text-white" }, reward.title),
                       React.createElement('div', { className: "text-xs text-slate-400 mt-1" }, `Meta: ${reward.cost} moedas`)
                     ]),
                     React.createElement('div', { className: "flex items-center gap-2" }, [ 
                        React.createElement('button', {
                            onClick: () => {
                                if (confirm("Tem certeza que deseja excluir esta recompensa?")) {
                                    onDelete(reward.id);
                                }
                            },
                            className: "p-2 rounded-lg text-red-500 hover:bg-slate-700 transition-colors",
                            title: "Excluir Recompensa"
                        }, React.createElement(Trash2, { size: 16 })),
                        React.createElement('button', {
                            onClick: () => onRedeem(reward.id, reward.cost),
                            disabled: currentCoins < reward.cost,
                            className: `px-4 py-2 rounded-lg text-sm font-bold transition-colors ${currentCoins >= reward.cost ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`
                        }, "Resgatar")
                     ])
                  ]),
                  React.createElement('div', { className: "w-full bg-slate-900 h-3 rounded-full overflow-hidden relative border border-slate-700/50" }, [
                    React.createElement('div', { className: "bg-gradient-to-r from-yellow-600 to-yellow-400 h-full transition-all duration-700", style: { width: `${percentage}%` } }),
                    React.createElement('div', { className: "absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-md" }, `${currentCoins} / ${reward.cost}`)
                  ])
                ]);
              })
            )
          ]);
        }
        
        function ActivityFeed({ feed, currentUserId, onEdit }) {
          return React.createElement('div', { className: "space-y-4" }, [
             React.createElement('h2', { className: "text-xl font-bold text-white mb-4 flex items-center gap-2", key: 'title' }, [
               React.createElement(TrendingUp, { className: "text-blue-400" }), " Atividade da Galera"
             ]),
             React.createElement('div', { className: "space-y-4 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-800", key: 'feed-list' },
               feed.map((item, i) => React.createElement('div', { key: item.id || i, className: "relative pl-10" }, [
                  React.createElement('div', { className: "absolute left-2 top-0 w-4 h-4 rounded-full bg-slate-700 border-2 border-slate-900 z-10 text-[10px] flex items-center justify-center" }, item.type === 'reward' ? 'üéÅ' : (item.type === 'win' ? 'üèÜ' : 'üí™')),
                  React.createElement('div', { className: "bg-slate-800 p-3 rounded-xl border border-slate-700 relative" }, [
                    React.createElement('div', { className: "flex items-center gap-2 mb-1" }, [
                      React.createElement('span', { className: "text-lg" }, item.userAvatar),
                      React.createElement('span', { className: "font-bold text-slate-200" }, item.userName),
                      React.createElement('span', { className: "text-xs text-slate-500 ml-auto" }, formatDate(item.timestamp)), 
                      (item.userId === currentUserId && item.type === 'workout' && onEdit) &&
                      React.createElement('button', {
                          onClick: () => onEdit(item),
                          className: "ml-2 text-slate-500 hover:text-blue-400 transition-colors"
                      }, React.createElement(Edit2, { size: 14 }))
                    ]),
                    item.type === 'workout' 
                      ? React.createElement('div', null, [
                          React.createElement('div', { className: "text-sm text-slate-300" }, [ 
                              "Completou ", 
                              React.createElement('span', { className: "font-bold capitalize text-blue-400" }, item.workoutLabel || item.workoutType), 
                              item.intensity === 'high' && React.createElement('span', { className: "ml-2 bg-orange-500/20 text-orange-400 text-[10px] px-1.5 py-0.5 rounded border border-orange-500/50 font-bold" }, "üî• INTENSO"),
                              item.isFirstTime && React.createElement('span', { className: "ml-2 bg-purple-500/20 text-purple-400 text-[10px] px-1.5 py-0.5 rounded border border-purple-500/50 font-bold" }, "‚ú® 1¬™ VEZ") // First Time Badge
                          ]),
                          item.notes && React.createElement('div', { className: "text-xs text-slate-500 mt-1 italic" }, `"${item.notes}"`),
                          React.createElement('div', { className: "mt-2 text-xs font-bold text-green-500" }, `+${item.xpGained} XP`)
                        ])
                      : (item.type === 'win' 
                          ? React.createElement('div', { className: "text-sm text-yellow-400 font-bold" }, [ "VENCEU O DESAFIO: ", item.challengeTitle, "!" ])
                          : React.createElement('div', { className: "text-sm text-slate-300" }, [ "Resgatou a recompensa: ", React.createElement('span', { className: "text-purple-400 font-bold" }, item.rewardTitle) ]))
                  ])
               ]))
             )
          ]);
        }

        // ... (AuthScreen remains same) ...
        function AuthScreen({ onLogin, onRegister, offlineMode, onRetryConnection }) {
           const [isRegistering, setIsRegistering] = useState(false);
           const [username, setUsername] = useState('');
           const [pin, setPin] = useState('');
           const [avatar, setAvatar] = useState(DEFAULT_AVATARS[0]);

           return React.createElement('div', { className: "min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white" }, [
             React.createElement('div', { className: "mb-8 text-center animate-fade-in", key: 'logo' }, [
               React.createElement('div', { className: "inline-block p-4 rounded-full bg-slate-800 mb-4 border-2 border-orange-500 relative" }, [
                  React.createElement(Flame, { size: 48, className: "text-orange-500" }),
                  offlineMode && React.createElement('div', { className: "absolute -top-2 -right-2 bg-red-600 rounded-full p-1 border-2 border-slate-900" }, React.createElement(WifiOff, { size: 12 }))
               ]),
               React.createElement('h1', { className: "text-4xl font-black text-white tracking-tight mb-2" }, "FitQuest"),
               React.createElement('p', { className: "text-slate-400" }, "Entre na competi√ß√£o."),
               offlineMode && React.createElement('div', { className: "mt-4 flex flex-col items-center gap-2" }, [
                   React.createElement('p', { className: "text-red-400 text-xs font-bold bg-red-900/20 py-1 px-3 rounded border border-red-800" }, "Modo Offline"),
                   React.createElement('button', { 
                       onClick: onRetryConnection,
                       className: "flex items-center gap-2 text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-white transition-colors"
                   }, [ React.createElement(RefreshCw, { size: 12 }), "Tentar Reconectar" ])
               ])
             ]),
             React.createElement('div', { className: "w-full max-w-sm bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl", key: 'card' }, [
                React.createElement('div', { className: "flex gap-2 mb-6 border-b border-slate-700 pb-4" }, [
                  React.createElement('button', { onClick: () => setIsRegistering(false), className: `flex-1 py-2 font-bold text-sm rounded transition-colors ${!isRegistering ? 'bg-slate-700 text-white' : 'text-slate-500'}` }, "Entrar"),
                  React.createElement('button', { onClick: () => setIsRegistering(true), className: `flex-1 py-2 font-bold text-sm rounded transition-colors ${isRegistering ? 'bg-orange-600 text-white' : 'text-slate-500'}` }, "Criar Conta")
                ]),
                React.createElement('div', { className: "space-y-4" }, [
                   React.createElement('div', null, [
                      React.createElement('label', { className: "block text-xs font-bold text-slate-400 uppercase mb-1" }, "Nome de Usu√°rio"),
                      React.createElement('input', { type: "text", value: username, onChange: e => setUsername(e.target.value), className: "w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-orange-500" })
                   ]),
                   React.createElement('div', null, [
                      React.createElement('label', { className: "block text-xs font-bold text-slate-400 uppercase mb-1" }, "PIN"),
                      React.createElement('input', { type: "password", value: pin, onChange: e => setPin(e.target.value), className: "w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-orange-500" })
                   ]),
                   isRegistering && React.createElement('div', { className: "animate-slide-up" }, [
                      React.createElement('label', { className: "block text-xs font-bold text-slate-400 uppercase mb-2" }, "Avatar"),
                      React.createElement('div', { className: "grid grid-cols-5 gap-2" }, DEFAULT_AVATARS.map(a => 
                        React.createElement('button', { key: a, onClick: () => setAvatar(a), className: `text-xl p-2 rounded-lg border-2 ${avatar === a ? 'border-orange-500 bg-slate-700' : 'border-transparent'}` }, a)
                      ))
                   ]),
                   React.createElement('button', {
                     onClick: () => { if(username && pin) isRegistering ? onRegister(username, pin, avatar) : onLogin(username, pin) },
                     className: `w-full font-bold py-3 rounded-lg shadow-lg transition-colors mt-2 ${isRegistering ? 'bg-orange-600 hover:bg-orange-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`
                   }, isRegistering ? 'Come√ßar Jornada' : 'Acessar Painel')
                ])
             ])
           ]);
        }

        // --- MAIN COMPONENT ---
        function FitQuestApp() {
          const [firebaseConnected, setFirebaseConnected] = useState(false);
          const [activeGameUser, setActiveGameUser] = useState(null);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [leaderboard, setLeaderboard] = useState([]);
          const [challenges, setChallenges] = useState([]);
          const [feed, setFeed] = useState([]);
          const [offlineMode, setOfflineMode] = useState(false);
          const [editingItem, setEditingItem] = useState(null); 
          const [exercises, setExercises] = useState(DEFAULT_EXERCISES); 
          const [showAdmin, setShowAdmin] = useState(false); 

          const connectFirebase = async () => {
             try { 
                 setOfflineMode(false); 
                 await signInAnonymously(auth); 
                 setFirebaseConnected(true);
             } catch (error) { 
                 console.error("Firebase connection error (likely Auth not enabled):", error);
                 setOfflineMode(true); 
                 alert("N√£o foi poss√≠vel conectar ao servidor. O app funcionar√° offline.");
             }
          };

          useEffect(() => {
            connectFirebase();
            const unsubscribe = onAuthStateChanged(auth, (u) => {
              if (u) setFirebaseConnected(true);
            });
            return () => unsubscribe();
          }, []);

          // Data Refresh Logic 
          const refreshData = async () => {
             if (offlineMode) {
                 if(activeGameUser) {
                    const users = LocalDB.getUsers();
                    const freshUser = users.find(u => u.id === activeGameUser.id);
                    if(freshUser) setActiveGameUser(freshUser);
                 }
                 const users = LocalDB.getUsers();
                 users.sort((a, b) => (b.xp || 0) - (a.xp || 0));
                 setLeaderboard(users);
                 setFeed(LocalDB.getFeed());
                 setChallenges(LocalDB.getChallenges());
                 
                 const customEx = LocalDB.getCustomExercises();
                 setExercises([...DEFAULT_EXERCISES, ...customEx]);
             }
          };

          // Data Listeners
          useEffect(() => {
            if (offlineMode) {
                refreshData();
                return; 
            }
            if (!firebaseConnected || !activeGameUser) return;

            // User Listener
            const userRef = doc(db, COLLECTION_NAME, activeGameUser.id);
            const unsubUser = onSnapshot(userRef, 
                (docSnap) => {
                    if (docSnap.exists()) setActiveGameUser({ id: docSnap.id, ...docSnap.data() });
                },
                (err) => {
                    setOfflineMode(true);
                    alert("Erro de Permiss√£o. Mudando para Offline.");
                }
            );

            // Leaderboard Listener
            const usersRef = collection(db, COLLECTION_NAME);
            const unsubLeaderboard = onSnapshot(usersRef, 
                (snapshot) => {
                    const users = [];
                    snapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    users.sort((a, b) => (b.xp || 0) - (a.xp || 0));
                    setLeaderboard(users);
                },
                (err) => { setOfflineMode(true); }
            );

            // Feed Listener
            const feedRef = collection(db, FEED_COLLECTION_NAME);
            const unsubFeed = onSnapshot(feedRef, 
                (snapshot) => {
                    const activities = [];
                    snapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));
                    activities.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setFeed(activities.slice(0, 20));
                },
                (err) => { setOfflineMode(true); }
            );

            // Challenges Listener
            const challengesRef = collection(db, CHALLENGES_COLLECTION_NAME);
            const unsubChallenges = onSnapshot(challengesRef,
                (snapshot) => {
                    const ch = [];
                    snapshot.forEach(doc => ch.push({ id: doc.id, ...doc.data() }));
                    ch.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setChallenges(ch);
                }
            );

            // Exercises Listener (Load custom exercises)
            const exercisesRef = collection(db, EXERCISES_COLLECTION_NAME);
            const unsubExercises = onSnapshot(exercisesRef, 
                (snapshot) => {
                    const customEx = [];
                    snapshot.forEach(doc => customEx.push({ id: doc.id, ...doc.data() }));
                    setExercises([...DEFAULT_EXERCISES, ...customEx]);
                }
            );

            return () => { unsubUser(); unsubLeaderboard(); unsubFeed(); unsubChallenges(); unsubExercises(); };
          }, [firebaseConnected, activeGameUser?.id, offlineMode]);

          // ... (Rest of actions: handleRegister, handleLogin, etc.) ...
          // IMPORTANT: Re-implementing Login/Register etc to use updated code context if needed, but keeping existing logic is fine.
          // Copying logic from previous blocks to ensure full functionality.

          const handleRegister = async (username, pin, avatar) => {
            const newUser = { username, pin, avatar, xp: 0, coins: 0, streak: 0, workoutsCompleted: 0, joinedAt: offlineMode ? Date.now() : serverTimestamp(), myRewards: [] };
            if (offlineMode) {
                const users = LocalDB.getUsers();
                if(users.some(u => u.username === username)) { alert("Usu√°rio existe (Local)."); return; }
                newUser.id = "local_" + Date.now();
                LocalDB.saveUser(newUser);
                setActiveGameUser(newUser);
                refreshData();
                return;
            }
            try {
                const usersRef = collection(db, COLLECTION_NAME);
                const q = query(usersRef, where("username", "==", username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) { alert("Este nome de usu√°rio j√° existe."); return; }
                const docRef = await addDoc(usersRef, newUser);
                setActiveGameUser({ id: docRef.id, ...newUser });
            } catch (err) {
                if(err.code === 'permission-denied') { setOfflineMode(true); newUser.id = "local_" + Date.now(); LocalDB.saveUser(newUser); setActiveGameUser(newUser); refreshData(); } 
                else { alert("Erro ao conectar."); }
            }
          };

          const handleLogin = async (username, pin) => {
            if (offlineMode) {
                const users = LocalDB.getUsers();
                const user = users.find(u => u.username === username && u.pin === pin);
                if (user) { setActiveGameUser(user); refreshData(); } else { alert("Login inv√°lido (Offline)."); }
                return;
            }
            try {
                const usersRef = collection(db, COLLECTION_NAME);
                const q = query(usersRef, where("username", "==", username), where("pin", "==", pin));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) { const userDoc = snapshot.docs[0]; setActiveGameUser({ id: userDoc.id, ...userDoc.data() }); } 
                else { alert("Usu√°rio ou PIN incorretos."); }
            } catch (err) {
                 if(err.code === 'permission-denied') { setOfflineMode(true); alert("Erro de permiss√£o. Tentando login local..."); const users = LocalDB.getUsers(); const user = users.find(u => u.username === username && u.pin === pin); if (user) setActiveGameUser(user); }
                 else { alert("Erro ao logar."); }
            }
          };

          const handleLogout = () => { setActiveGameUser(null); };

          const handleLogWorkout = async (typeId, intensity, notes, dateStr, isFirstTime) => {
            if (!activeGameUser) return;
            
            let timestamp;
            let currentWorkoutDate = new Date();
            if (dateStr) {
                const parts = dateStr.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0); 
                timestamp = offlineMode ? { seconds: d.getTime() / 1000 } : d; 
                currentWorkoutDate = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                timestamp = offlineMode ? { seconds: Date.now() / 1000 } : serverTimestamp();
            }
            currentWorkoutDate.setHours(0,0,0,0);

            // USE DYNAMIC EXERCISES LIST
            const exercise = exercises.find(e => e.id === typeId) || exercises[0];
            let baseXp = exercise.xp;
            let bonusXp = isFirstTime ? 100 : 0;
            let earnedXp = baseXp + bonusXp; 
            const earnedCoins = Math.floor(earnedXp / 10);

            // Edit Mode
            if (editingItem) {
                const diffXp = earnedXp - editingItem.xpGained;
                const diffCoins = earnedCoins - Math.floor(editingItem.xpGained / 10);
                const updatedItem = { ...editingItem, workoutType: typeId, workoutLabel: exercise.label, xpGained: earnedXp, notes: notes, intensity: intensity, isFirstTime: isFirstTime, timestamp: timestamp };

                if (offlineMode) {
                    const updatedUser = { ...activeGameUser, xp: (activeGameUser.xp || 0) + diffXp, coins: (activeGameUser.coins || 0) + diffCoins };
                    LocalDB.saveUser(updatedUser); LocalDB.updateFeedItem(updatedItem); setActiveGameUser(updatedUser); setEditingItem(null); refreshData(); alert("Atualizado!"); return;
                }
                try {
                    const userRef = doc(db, COLLECTION_NAME, activeGameUser.id);
                    await updateDoc(userRef, { xp: increment(diffXp), coins: increment(diffCoins) });
                    const feedRef = doc(db, FEED_COLLECTION_NAME, editingItem.id);
                    await updateDoc(feedRef, updatedItem);
                    setEditingItem(null); alert("Atualizado!");
                } catch (err) { alert("Erro ao editar."); }
                return;
            }
            
            // Streak Logic
            let newStreak = activeGameUser.streak || 0;
            let lastWorkoutDate = null;
            if (activeGameUser.lastWorkout) {
                if (activeGameUser.lastWorkout.seconds) lastWorkoutDate = new Date(activeGameUser.lastWorkout.seconds * 1000);
                else if (typeof activeGameUser.lastWorkout === 'string') lastWorkoutDate = new Date(activeGameUser.lastWorkout);
                else lastWorkoutDate = new Date(activeGameUser.lastWorkout);
                lastWorkoutDate.setHours(0,0,0,0);
            }

            if (!lastWorkoutDate) newStreak = 1;
            else {
                const diffTime = currentWorkoutDate.getTime() - lastWorkoutDate.getTime();
                const diffDays = Math.round(diffTime / (1000 * 3600 * 24));
                if (diffDays === 1) newStreak += 1;
                else if (diffDays > 1) newStreak = 1;
                else if (diffDays === 0 && newStreak === 0) newStreak = 1;
            }
            
            const feedItem = { userId: activeGameUser.id, userName: activeGameUser.username, userAvatar: activeGameUser.avatar, type: 'workout', workoutType: typeId, workoutLabel: exercise.label, xpGained: earnedXp, timestamp: timestamp, notes: notes || '', intensity: intensity, isFirstTime: isFirstTime };

            if (offlineMode) {
                const updatedUser = { ...activeGameUser, xp: (activeGameUser.xp || 0) + earnedXp, coins: (activeGameUser.coins || 0) + earnedCoins, streak: newStreak, workoutsCompleted: (activeGameUser.workoutsCompleted || 0) + 1, lastWorkout: timestamp };
                LocalDB.saveUser(updatedUser); LocalDB.addToFeed(feedItem); setActiveGameUser(updatedUser); refreshData(); alert(`Registrado! +${earnedXp} XP`); setActiveTab('dashboard'); return;
            }

            try {
                const userRef = doc(db, COLLECTION_NAME, activeGameUser.id);
                await updateDoc(userRef, { xp: increment(earnedXp), coins: increment(earnedCoins), streak: newStreak, workoutsCompleted: increment(1), lastWorkout: timestamp });
                const feedRef = collection(db, FEED_COLLECTION_NAME);
                await addDoc(feedRef, feedItem);
                alert(`Registrado! +${earnedXp} XP`); setActiveTab('dashboard');
            } catch (err) { setOfflineMode(true); alert("Erro de conex√£o. Mudando para offline."); }
          };

          // ... (Existing helper functions: handleCreateChallenge, handleClaimWin, handleAddReward, handleRedeemReward, handleDeleteReward) ...
          // Re-declaring for scope completeness
          const handleCreateChallenge = async (title, targetXP, prize) => {
             const baselines = {}; leaderboard.forEach(u => { baselines[u.id] = u.xp || 0; });
             const newChallenge = { id: "ch_" + Date.now(), title, targetXP, prize, winnerId: null, createdAt: offlineMode ? Date.now() : serverTimestamp(), createdBy: activeGameUser.id, baselines };
             if (offlineMode) { LocalDB.saveChallenge(newChallenge); refreshData(); return; }
             try { await addDoc(collection(db, CHALLENGES_COLLECTION_NAME), newChallenge); } catch(err) { alert("Erro ao criar desafio."); }
          };
          const handleClaimWin = async (challengeId) => {
             const challenge = challenges.find(c => c.id === challengeId); if(!challenge || challenge.winnerId) return;
             const feedItem = { userId: activeGameUser.id, userName: activeGameUser.username, userAvatar: activeGameUser.avatar, type: 'win', challengeTitle: challenge.title, timestamp: { seconds: Date.now() / 1000 } };
             if(offlineMode) { LocalDB.saveChallenge({ ...challenge, winnerId: activeGameUser.id }); LocalDB.addToFeed(feedItem); refreshData(); alert("Venceu!"); return; }
             try { await updateDoc(doc(db, CHALLENGES_COLLECTION_NAME, challenge.id), { winnerId: activeGameUser.id }); await addDoc(collection(db, FEED_COLLECTION_NAME), { ...feedItem, timestamp: serverTimestamp() }); alert("Venceu!"); } catch(err) {}
          };
          const handleAddReward = async (title, cost) => {
             const newReward = { id: Date.now().toString(), title, cost: parseInt(cost), redeemed: false };
             if (offlineMode) { LocalDB.saveUser({ ...activeGameUser, myRewards: [...(activeGameUser.myRewards || []), newReward] }); setActiveGameUser({ ...activeGameUser, myRewards: [...(activeGameUser.myRewards || []), newReward] }); return; }
             try { await updateDoc(doc(db, COLLECTION_NAME, activeGameUser.id), { myRewards: [...(activeGameUser.myRewards || []), newReward] }); } catch(err) { setOfflineMode(true); }
          };
          const handleRedeemReward = async (rewardId, cost) => {
             const updatedRewards = activeGameUser.myRewards.map(r => r.id === rewardId ? { ...r, redeemed: true } : r);
             const rewardTitle = activeGameUser.myRewards.find(r => r.id === rewardId)?.title;
             const feedItem = { userId: activeGameUser.id, userName: activeGameUser.username, userAvatar: activeGameUser.avatar, type: 'reward', rewardTitle: rewardTitle, timestamp: { seconds: Date.now() / 1000 } };
             if (offlineMode) { LocalDB.saveUser({ ...activeGameUser, coins: (activeGameUser.coins || 0) - cost, myRewards: updatedRewards }); LocalDB.addToFeed(feedItem); setActiveGameUser({ ...activeGameUser, coins: (activeGameUser.coins || 0) - cost, myRewards: updatedRewards }); refreshData(); return; }
             try { await updateDoc(doc(db, COLLECTION_NAME, activeGameUser.id), { coins: increment(-cost), myRewards: updatedRewards }); await addDoc(collection(db, FEED_COLLECTION_NAME), { ...feedItem, timestamp: serverTimestamp() }); } catch(err) { setOfflineMode(true); }
          };
          const handleDeleteReward = async (rewardId) => {
             if (!activeGameUser) return;
             const updatedRewards = activeGameUser.myRewards.filter(r => r.id !== rewardId);
             if (offlineMode) { LocalDB.saveUser({ ...activeGameUser, myRewards: updatedRewards }); setActiveGameUser({ ...activeGameUser, myRewards: updatedRewards }); return; }
             try { await updateDoc(doc(db, COLLECTION_NAME, activeGameUser.id), { myRewards: updatedRewards }); } catch(err) { setOfflineMode(true); }
          };

          // Admin Action
          const handleAddCustomExercise = async (newEx) => {
              if(offlineMode) {
                  LocalDB.saveCustomExercise(newEx);
                  setExercises(prev => [...prev, newEx]);
              } else {
                  try {
                      await setDoc(doc(db, EXERCISES_COLLECTION_NAME, newEx.id), newEx);
                      // Listener will update state
                  } catch(err) {
                      console.error(err);
                      alert("Erro ao salvar exerc√≠cio.");
                  }
              }
              setShowAdmin(false);
          };

          const handleAdminClick = () => {
              const pwd = prompt("Senha de Administrador:");
              if(pwd === "290517") {
                  setShowAdmin(true);
              } else if (pwd) {
                  alert("Senha incorreta.");
              }
          };

          if (!activeGameUser) return React.createElement(AuthScreen, { onLogin: handleLogin, onRegister: handleRegister, offlineMode, onRetryConnection: connectFirebase });

          return React.createElement('div', { className: "min-h-screen bg-slate-900 text-slate-100 font-sans pb-20" }, [
            // Admin Modal
            showAdmin && React.createElement(AdminExerciseModal, { onClose: () => setShowAdmin(false), onSave: handleAddCustomExercise }),

            // Header
            React.createElement('div', { className: "bg-slate-800 p-4 sticky top-0 z-50 shadow-lg border-b border-slate-700", key: "header" }, [
              React.createElement('div', { className: "flex justify-between items-center mb-2" }, [
                React.createElement('h1', { className: "text-xl font-bold text-orange-500 flex items-center gap-2" }, [ React.createElement(Flame), " FitQuest" ]),
                React.createElement('div', { className: "flex items-center gap-3" }, [
                   // Admin Button
                   React.createElement('button', { onClick: handleAdminClick, className: "text-slate-500 hover:text-white" }, React.createElement(Lock, { size: 16 })),
                   
                   React.createElement('div', { className: "flex items-center gap-1", title: offlineMode ? "Modo Offline" : "Online" }, 
                        offlineMode 
                        ? React.createElement(WifiOff, { size: 16, className: "text-red-500" }) 
                        : React.createElement(Wifi, { size: 16, className: "text-green-500" })
                   ),
                   React.createElement('button', { onClick: handleLogout }, React.createElement(LogOut, { size: 18 })),
                   React.createElement('div', { className: "bg-slate-700 px-3 py-1 rounded-full text-sm font-bold text-yellow-400" }, `ü™ô ${activeGameUser.coins || 0}`),
                   React.createElement('div', { className: "h-8 w-8 rounded-full bg-slate-600 flex items-center justify-center text-xl border-2 border-slate-500" }, activeGameUser.avatar)
                ])
              ]),
              React.createElement('div', { className: "w-full bg-slate-700 h-2 rounded-full mt-2 overflow-hidden" },
                React.createElement('div', { className: "bg-gradient-to-r from-blue-500 to-cyan-400 h-full", style: { width: `${getProgressToNextLevel(activeGameUser.xp || 0)}%` } })
              )
            ]),

            // Content
            React.createElement('div', { className: "p-4 max-w-md mx-auto", key: "content" }, [
               offlineMode && React.createElement('div', { className: "bg-red-500/10 border border-red-500/50 text-red-200 text-xs p-2 rounded mb-4 flex items-center gap-2" }, [
                   React.createElement(AlertTriangle, { size: 14 }), " Modo Offline: Dados salvos apenas neste dispositivo."
               ]),
               
               (activeTab === 'dashboard' && !editingItem) && React.createElement(Dashboard, { user: activeGameUser, onLogClick: () => setActiveTab('log'), leaderboard: leaderboard, currentUserId: activeGameUser.id }),
               
               (activeTab === 'log' || editingItem) && React.createElement(WorkoutLogger, { 
                   onLog: handleLogWorkout, 
                   onCancel: () => { setEditingItem(null); setActiveTab('dashboard'); },
                   initialData: editingItem,
                   availableExercises: exercises // Pass dynamic list
               }),
               
               (activeTab === 'leaderboard' && !editingItem) && React.createElement(Leaderboard, { users: leaderboard, currentUserId: activeGameUser.id }),
               (activeTab === 'challenges' && !editingItem) && React.createElement(ChallengeList, { challenges: challenges, users: leaderboard, currentUserId: activeGameUser.id, onCreateChallenge: handleCreateChallenge, onClaimWin: handleClaimWin }),
               (activeTab === 'rewards' && !editingItem) && React.createElement(RewardShop, { user: activeGameUser, onAdd: handleAddReward, onRedeem: handleRedeemReward, onDelete: handleDeleteReward }),
               (activeTab === 'feed' && !editingItem) && React.createElement(ActivityFeed, { 
                   feed: feed, 
                   currentUserId: activeGameUser.id,
                   onEdit: (item) => { setEditingItem(item); setActiveTab('log'); }
               })
            ]),

            // Navigation
            React.createElement('div', { className: "fixed bottom-0 left-0 w-full bg-slate-800 border-t border-slate-700 p-2 flex justify-around items-center z-20 pb-safe", key: "nav" }, [
               React.createElement(NavButton, { Icon: Activity, label: "Painel", active: activeTab === 'dashboard', onClick: () => { setEditingItem(null); setActiveTab('dashboard'); } }),
               React.createElement(NavButton, { Icon: Target, label: "Desafios", active: activeTab === 'challenges', onClick: () => { setEditingItem(null); setActiveTab('challenges'); } }),
               React.createElement('div', { className: "relative -top-5" }, 
                 React.createElement('button', { onClick: () => { setEditingItem(null); setActiveTab('log'); }, className: "bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-full shadow-lg border-4 border-slate-900" }, React.createElement(PlusCircle, { size: 32 }))
               ),
               React.createElement(NavButton, { Icon: ShoppingBag, label: "Pr√™mios", active: activeTab === 'rewards', onClick: () => { setEditingItem(null); setActiveTab('rewards'); } }),
               React.createElement(NavButton, { Icon: TrendingUp, label: "Feed", active: activeTab === 'feed', onClick: () => { setEditingItem(null); setActiveTab('feed'); } })
            ])
          ]);
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(FitQuestApp));
    </script>
</body>
</html>
